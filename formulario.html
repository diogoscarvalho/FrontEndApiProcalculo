<!Doctype html>
<html>
<head>
	<title>Solicitação de Calculo</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
</head>
<body>
  <div class="jumbotron">
  <div class="container">
	<h1 class="text-primary">
		Solicitacão de Cálculo
	</h1>
    <form id="frmSolicitacao" name="frmSolicitacao" method="POST" class="form">
	<div id="dadosSolicitacao">
  <div class="form-group col-xs-5">
    <label class="aria-label text-primary">Nome do Solicitante:</label>
    <input type="text" class="form-control" id="nomeSolicitante" name="nomeSolicitante">
  </div>
  <div class="form-group col-xs-5">
    <label class="aria-label text-primary">Email do Solicitante:</label>
    <input class="form-control " type="email" id="emailSolicitante" name="emailSolicitante">
  </div>
  <div class="form-group col-xs-5">
    <label class="aria-label text-primary">Código do caso:</label>
    <input type="text" class="form-control" id="idCaso" name="idCaso">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Nome Reclamada:</label>
  <input class="form-control" type="text" id="nomeReclamada" name="nomeReclamada">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Finalidade:</label>
  <select id="idFinalidade" name="idFinalidade" class="form-control">
  <option value="1">Finalidade 1</option>
  <option value="2">Finalidade 2</option>
  <option value="3">Finalidade 3</option>
  </select>
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Fase do cálculo:</label>
  <input type="text" id="idFaseCalculo" name="idFaseCalculo" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Data da Fase:</label>
  <input type="date" id="dataFase" name="dataFase" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Prazo fatal:</label>
  <input type="date" id="prazoFatal" name="prazoFatal" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Unidade reclamada:</label>
  <input type="text" id="unidadeReclamada" name="unidadeReclamada" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Data da distribuição:</label>
  <input type="date" id="dataDistribuicao" name="dataDistribuicao" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Número do processo:</label>
  <input type="text" id="numeroProcesso" name="numeroProcesso" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Comarca:</label>
  <input type="text" id="comarca" name="comarca" class="form-control">
  </div>
  <div class="form-group col-xs-5">
    <label class="aria-label text-primary">Uf:</label>
  <select id="Uf" name="Uf" class="form-control">
  <option value="SP">SP</option>
  <option value="RJ">RJ</option>
  <option value="SC">SC</option>
  </select>
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Forum:</label>
  <input type="text" id="forum" name="forum" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Vara:</label>
  <input type="text" id="vara" name="vara" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Responsabilidade:</label>
  <select id="idResponsabilidade" name="idResponsabilidade" class="form-control">
    <option value="1">Responsabilidade 1</option>
    <option value="2">Responsabilidade 2</option>
    <option value="3">Responsabilidade 3</option>
  </select>
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Empresa terceira:</label>
  <input type="text" id="empresaTerceira" name="empresaTerceira" class="form-control">
  </div>
  <div class="form-group col-xs-5">
  <label class="aria-label text-primary">Analista:</label>
  <select id="idAnalista" name="idAnalista" class="form-control">
    <option value="1">Analista 1</option>
    <option value="2">Analista 2</option>
    <option value="3">Analista 3</option>
  </select>
  </div>
  </div>
  <div id="reclamantes" class="form-group col-xs-10">
	<fieldset>
	 <legend><span>Reclamantes</span></legend>
    <div class="reclamantes-info col-xs-10">
      <div class="form-group col-xs-4">
	  <input type="hidden" name="index" value="1">
      <label class="aria-label text-primary">CPF:</label>
      <input type="text" name="cpf-1" placeholder="e.p xxx.xxx.xxx-xx" class="form-control">
      </div>
      <div class="form-group col-xs-4">
      <label class="aria-label text-primary">Nome:</label>
      <input type="text" name="nome-1" class="form-control">
      </div>
      <div class="form-group col-xs-4">
      <label class="aria-label text-primary">Paradigma:</label>
      <select name="paradigma-1" class="form-control">
      <option value="1">Paradigma 1</option>
      <option value="2">Paradigma 2</option>
      </select>
      </div>
	  <div class="col-xs-3">
	  <button type="button" id="btnRemoverReclamante-1" class="btnRemoverReclamante" name="btnRemoverReclamante-1">
		<span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
	  </button>
    </div>
  </div>
  </fieldset>
	<div class="col-xs-5">
		<button type="button" id="btnAdicionarReclamante">
			<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
	    </button>
      </div>
  </div>
  <div id="arquivos" class="form-group col-xs-10">
	<fieldset>
	 <legend><span>Arquivos</span></legend>
    <div class="arquivos-info col-xs-10">
      <div class="form-group col-xs-5">
	  <input type="hidden" name="index" value="1">
      <label class="aria-label text-primary">Nome:</label>
      <input type="text" name="nomeArquivo-1" placeholder="e.p xxx.xxx.xxx-xx" class="form-control">
      </div>
      <div class="form-group col-xs-5">
      <label class="aria-label text-primary">Arquivo Base64:</label>
      <input type="text" name="base64-1" class="form-control">
      </div>
	  <div class="col-xs-4">
	  <button type="button" id="btnRemoverArquivo-1" class="btnRemoverArquivo" name="btnRemoverArquivo-1">
		<span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
	  </button>
    </div>
  </div>
  </fieldset>
	<div class="col-xs-5">
		<button type="button" id="btnAdicionarArquivo">
			<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
	    </button>
      </div>
  </div>
  <input type="button" id="btnEnviar" value="Enviar" class="btn btn-primary btn-lg col-xs-3">
  </form>
  </div>
  </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript">
$(function(){
 	
	$("#btnRemoverReclamante-1").hide();
	$("#btnRemoverArquivo-1").hide();
	
	$('#btnAdicionarReclamante').on('click', function(){
		inserirBlocoReclamante();
	});

	$('.btnRemoverReclamante').on('click', function(){
		$(this).parent().parent().remove();
	});
	
	$('#btnAdicionarArquivo').on('click', function(){
		inserirBlocoArquivo();
	});

	$('.btnRemoverArquivo').on('click', function(){
		$(this).parent().parent().remove();
	});
	
	$('#btnEnviar').on('click', function(){
		var SolicitacaoValues = $('#dadosSolicitacao :input');
		var reclamantesValues = $('#reclamantes :input').not(':hidden, :button');
		var arquivosValues = $('#arquivos :input').not(':hidden, :button');
		
        var objEnvio = preparaObjetoEnvio(SolicitacaoValues, reclamantesValues, arquivosValues);
		
		$.ajax({
			beforeSend: function (xhr) {
				xhr.setRequestHeader ("Authorization", "Basic " + btoa("dcarvalho" + ":" + "dcarvalho"));
			},
			method:'POST',
			url: 'http://localhost:12670/api/Calculo/',
			type: 'json',
			contentType: 'application/json',
			data: objEnvio
		})
		.always(function(){
			$('#frmSolicitacao').trigger('reset');
		})
		.done(function(data){
			alert("Solicitação de cálculo enviada com sucesso \n" +
					"Número da solicitação: " + data[0].idSolicitacao + "\n" +
					"Código do cliente: " + data[0].idCliente + "\n" +
					"Código do caso: " + data[0].idCaso + "\n" +
					"Fase do cálculo: " + data[0].idFaseCalculo + "\n" +
					"Status: " + data[0].status);
					
			$('#frmSolicitacao').submit();
		})
		.fail(function(jqHtQ, errorMessagem, throwMessage){
			alert("Falha ao solicitar cálculo");
		});
		
	});
	
	function inserirBlocoReclamante(){
		var bloco = $('.reclamantes-info:first').clone(true),
		index = parseInt(bloco.find('input[name="index"]').val()) + 1;
	
		bloco.find('input[name^="nome-"]').attr('name', 'nome-'+index).val('');
		bloco.find('input[name^="cpf-"]').attr('name', 'cpf-'+index).val('');
		bloco.find('select[name^="paradigma-"]').attr('name', 'paradigma-'+index).val($('option:first').val());
		bloco.find('button[name^="btnRemoverReclamante-"]').attr('name', 'btnRemoverReclamante-'+index).show();
		
		
		bloco.insertAfter('.reclamantes-info:last');
	};
	
	function inserirBlocoArquivo(){
		var bloco = $('.arquivos-info:first').clone(true),
		index = parseInt(bloco.find('input[name="index"]').val()) + 1;
	
		bloco.find('input[name^="nome-"]').attr('name', 'nomeArquivo-'+index).val('');
		bloco.find('input[name^="cpf-"]').attr('name', 'base64-'+index).val('');
		bloco.find('button[name^="btnRemoverArquivo-"]').attr('name', 'btnRemoverArquivo-'+index).show();
		
		
		bloco.insertAfter('.arquivos-info:last');
	};
	
	function preparaArrayArquivos(arquivos){
		var arquivoArray = new Array();
		for(j = 0; j < (arquivos.length)/2; j++){
			var arquivo = new Object();
			var cont = 0;
			for(i = (j*2); i < arquivos.length; i++){
				if(cont < 2){
					if(arquivos[i].name.indexOf("nomeArquivo") > -1){
						arquivo.fileName = arquivos[i].value;
						cont++;
					}			
					if(arquivos[i].name.indexOf("base64") > -1){
						arquivo.file = arquivos[i].value;
						cont++;
					}			
				}				
			}
			arquivoArray.push(arquivo);
		}
		
		return arquivoArray;
	}
	
	function preparaObjetoEnvio(solicitacao, reclamantes, pArquivos){
		var obj = {};
		
		$.map(solicitacao, function(n, i) {
			obj[n.name] = $(n).val();
		});
			
		var vetor = new Array();
		
		for(j = 0; j < (reclamantes.length)/3; j++){
			var reclamante = new Object();
			var cont = 0;
			for(i = (j*3); i < reclamantes.length; i++){
				if(cont < 3){
					if(reclamantes[i].name.indexOf("nome") > -1){
						reclamante.nome = reclamantes[i].value;
						cont++;
					}			
					if(reclamantes[i].name.indexOf("cpf") > -1){
						reclamante.cpf = reclamantes[i].value;
						cont++;
					}			
					if(reclamantes[i].name.indexOf("paradigma") > -1){
						reclamante.paradigma = reclamantes[i].value;
						cont++;
					}
				}				
			}
			vetor.push(reclamante);
		}
		
		obj.arquivos = preparaArrayArquivos(pArquivos);
		obj.reclamantes = vetor;
		
		var objArray = new Array();
		objArray.push(obj);
		
		return JSON.stringify(objArray);
	};
});
</script>
</html>